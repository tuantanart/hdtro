
import React, { useState, useCallback, useEffect } from 'react';
import ReactDOM from 'react-dom/client';

// === From types.ts ===
interface RoomData {
  'T√äN PH√íNG': string;
  'T√äN': string;
  'TI·ªÄN PH√íNG': string;
  'S·ªê NG∆Ø·ªúI': string;
  'ƒêI·ªÜN C≈®': string;
  'ƒêI·ªÜN M·ªöI': string;
  'T·ªîNG S·ªê ƒêI·ªÜN': string;
  'T·ªîNG TI·ªÄN ƒêI·ªÜN': string;
  'N∆Ø·ªöC': string;
  'DV': string;
  'T·ªîNG TI·ªÄN PH·∫¢I THANH TO√ÅN': string;
}

interface PaymentInfo {
  bankName: string;
  accountNumber: string;
  accountName: string;
  paymentNote: string;
}

interface InvoiceData {
  roomData: RoomData;
  paymentInfo: PaymentInfo;
}


// === From utils/sheetUtils.ts ===
interface A1Range {
  startRow: number;
  startCol: number;
  endRow: number;
  endCol: number;
}

function parseGidFromUrl(url: string): string {
  const match = url.match(/[#&]gid=([0-9]+)/);
  if (match && match[1]) {
    return match[1];
  }
  return '0'; // Default to the first sheet if no GID is found
}

function colA1ToIndex(col: string): number {
  let index = 0;
  for (let i = 0; i < col.length; i++) {
    index = index * 26 + (col.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
  }
  return index - 1;
}

function indexToA1Col(index: number): string {
  let col = '';
  let tempIndex = index + 1;
  while (tempIndex > 0) {
    const rem = tempIndex % 26;
    if (rem === 0) {
      col = 'Z' + col;
      tempIndex = Math.floor(tempIndex / 26) - 1;
    } else {
      col = String.fromCharCode(rem - 1 + 'A'.charCodeAt(0)) + col;
      tempIndex = Math.floor(tempIndex / 26);
    }
  }
  return col;
}

function parseA1Notation(range: string): A1Range | null {
  const rangeRegex = /^([A-Z]+)([0-9]+):([A-Z]+)([0-9]+)$/i;
  const match = range.match(rangeRegex);

  if (!match) return null;

  const [, startColStr, startRowStr, endColStr, endRowStr] = match;

  return {
    startRow: parseInt(startRowStr, 10) - 1,
    startCol: colA1ToIndex(startColStr.toUpperCase()),
    endRow: parseInt(endRowStr, 10) - 1,
    endCol: colA1ToIndex(endColStr.toUpperCase()),
  };
}

function getGoogleSheetDataUrl(sheetUrl: string, range: A1Range, gid: string): string | null {
  const idRegex = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
  const idMatch = sheetUrl.match(idRegex);

  if (idMatch && idMatch[1]) {
    const sheetId = idMatch[1];
    
    const columns = [];
    for (let i = range.startCol; i <= range.endCol; i++) {
      columns.push(indexToA1Col(i));
    }
    
    const query = `select ${columns.join(',')} limit ${range.endRow - range.startRow + 1} offset ${range.startRow}`;
    const encodedQuery = encodeURIComponent(query);
    
    return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}&tq=${encodedQuery}`;
  }

  return null;
}

function normalizeHeader(str: string): string {
  if (typeof str !== 'string') return String(str);
  return str
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/ƒê/g, 'D')
    .toUpperCase()
    .replace(/[\n\r]+/g, ' ')
    .replace(/"/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

const CANONICAL_HEADER_MAP: { [key: string]: keyof RoomData } = {
  'TEN PHONG': 'T√äN PH√íNG',
  'TEN': 'T√äN',
  'TIEN PHONG': 'TI·ªÄN PH√íNG',
  'SO NGUOI': 'S·ªê NG∆Ø·ªúI',
  'DIEN CU': 'ƒêI·ªÜN C≈®',
  'DIEN MOI': 'ƒêI·ªÜN M·ªöI',
  'TONG SO DIEN': 'T·ªîNG S·ªê ƒêI·ªÜN',
  'TONG TIEN DIEN': 'T·ªîNG TI·ªÄN ƒêI·ªÜN',
  'NUOC': 'N∆Ø·ªöC',
  'DV': 'DV',
  'TONG TIEN PHAI THANH TOAN': 'T·ªîNG TI·ªÄN PH·∫¢I THANH TO√ÅN',
};

const REQUIRED_HEADERS = Object.values(CANONICAL_HEADER_MAP);

function parseGvizJson(json: any): RoomData[] {
  if (!json || !json.table || !json.table.cols || !json.table.rows) {
    if (json && json.errors) {
      const errorMessages = json.errors.map((e: any) => e.detailed_message).join(', ');
      throw new Error(`L·ªói t·ª´ Google Sheets: ${errorMessages}`);
    }
    return [];
  }
  
  const sheetHeaders: string[] = json.table.cols.map((col: any) => col.label || '');

  const headerMapping: (keyof RoomData | null)[] = sheetHeaders.map(sheetHeader => {
    const normalized = normalizeHeader(sheetHeader);
    return CANONICAL_HEADER_MAP[normalized] || null;
  });

  const foundHeaders = headerMapping.filter(h => h !== null);
  if (foundHeaders.length < 3) { // Heuristic check
    throw new Error("Kh√¥ng t√¨m th·∫•y c√°c ti√™u ƒë·ªÅ c·ªôt c·∫ßn thi·∫øt (vd: 'T√äN PH√íNG', 'T√äN') trong v√πng d·ªØ li·ªáu b·∫°n ƒë√£ ch·ªçn. Vui l√≤ng ki·ªÉm tra l·∫°i v√πng d·ªØ li·ªáu c√≥ bao g·ªìm h√†ng ti√™u ƒë·ªÅ kh√¥ng.");
  }
  
  const dataRows = json.table.rows;

  return dataRows
    .map((rowObj: any): Partial<RoomData> | null => {
      if (!rowObj || !rowObj.c) return null;

      const values = rowObj.c.map((cell: any) => {
        if (cell === null) return '';
        return cell.f ?? cell.v ?? '';
      });
      
      const entry: Partial<RoomData> = {};
      let hasAnyValue = false;
      headerMapping.forEach((canonicalKey, index) => {
        if (canonicalKey && index < values.length) {
          const value = String(values[index]).trim();
          entry[canonicalKey] = value;
          if(value !== '') hasAnyValue = true;
        }
      });
      
      if (!hasAnyValue) return null;

      return entry;
    })
    .filter((row): row is Partial<RoomData> => {
        if (!row) return false;
        const hasIdentifier = (row['T√äN PH√íNG'] && row['T√äN PH√íNG'].trim() !== '') || (row['T√äN'] && row['T√äN'].trim() !== '');
        return hasIdentifier;
    })
    .map((row: Partial<RoomData>) => {
      const completeRow: any = {};
      REQUIRED_HEADERS.forEach(header => {
        completeRow[header] = row[header] || '';
      });
      return completeRow as RoomData;
    });
}


// === From components/Spinner.tsx ===
const Spinner = ({ className = 'h-5 w-5 text-white' }: { className?: string }): React.ReactNode => (
  <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>
);


// === From components/InvoiceModal.tsx ===
function InvoiceModal({ isOpen, onClose, roomData, paymentInfo }: { isOpen: boolean; onClose: () => void; roomData: RoomData | null; paymentInfo: PaymentInfo | null; }): React.ReactNode {
  if (!isOpen || !roomData || !paymentInfo) return null;

  const getPlainTextInvoice = (roomData: RoomData, paymentInfo: PaymentInfo): string => {
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const paymentNote = paymentInfo.paymentNote.replace('{thang}', `${currentMonth}`);

    const items = [
      { label: 'Ti·ªÅn thu√™ ph√≤ng', value: roomData['TI·ªÄN PH√íNG'] },
      { label: 'Ti·ªÅn ƒëi·ªán', value: roomData['T·ªîNG TI·ªÄN ƒêI·ªÜN'], detail: `(C≈©: ${roomData['ƒêI·ªÜN C≈®']}, M·ªõi: ${roomData['ƒêI·ªÜN M·ªöI']}, D√πng: ${roomData['T·ªîNG S·ªê ƒêI·ªÜN']} kWh)` },
      { label: 'Ti·ªÅn n∆∞·ªõc', value: roomData['N∆Ø·ªöC'] },
      { label: 'Ph√≠ d·ªãch v·ª•', value: roomData['DV'] },
    ];

    const itemsText = items
      .filter(item => item.value && item.value.trim() !== '' && item.value.trim() !== '0' && item.value.trim() !== '0 ƒë')
      .map((item) => {
        let line = `- ${item.label}: ${item.value}`;
        if (item.label === 'Ti·ªÅn ƒëi·ªán' && roomData['T·ªîNG S·ªê ƒêI·ªÜN'] && roomData['T·ªîNG S·ªê ƒêI·ªÜN'] !== '0') {
            line += ` ${item.detail}`;
        }
        return line;
    }).join('\n');

    const invoiceText = `
Ch√†o b·∫°n ${roomData['T√äN']},

Nh√† tr·ªç xin g·ª≠i b·∫°n th√¥ng b√°o ti·ªÅn nh√† th√°ng ${currentMonth}/${currentYear} cho ph√≤ng ${roomData['T√äN PH√íNG']} (S·ªë ng∆∞·ªùi: ${roomData['S·ªê NG∆Ø·ªúI'] || 'N/A'}).

Chi ti·∫øt c√°c kho·∫£n ph√≠:
${itemsText}

------------------------------------
T·ªîNG C·ªòNG THANH TO√ÅN: ${roomData['T·ªîNG TI·ªÄN PH·∫¢I THANH TO√ÅN']}
------------------------------------

B·∫°n vui l√≤ng thanh to√°n s·ªõm.

Th√¥ng tin chuy·ªÉn kho·∫£n:
- Ng√¢n h√†ng: ${paymentInfo.bankName}
- S·ªë t√†i kho·∫£n: ${paymentInfo.accountNumber}
- Ch·ªß t√†i kho·∫£n: ${paymentInfo.accountName}
- N·ªôi dung: "${paymentNote}"

C·∫£m ∆°n b·∫°n!
`;
    return invoiceText.replace(/^\s+/gm, '').trim();
  };

  const currentMonth = new Date().getMonth() + 1;
  const currentYear = new Date().getFullYear();
  const currentDate = new Date().toLocaleDateString('vi-VN');
  const paymentNote = paymentInfo.paymentNote.replace('{thang}', `${currentMonth}`);
  
  const invoiceItems = [
    { label: 'Ti·ªÅn thu√™ ph√≤ng', value: roomData['TI·ªÄN PH√íNG'], detail: '-' },
    { label: 'Ti·ªÅn ƒëi·ªán', value: roomData['T·ªîNG TI·ªÄN ƒêI·ªÜN'], detail: `C≈©: ${roomData['ƒêI·ªÜN C≈®']} M·ªõi: ${roomData['ƒêI·ªÜN M·ªöI']} (${roomData['T·ªîNG S·ªê ƒêI·ªÜN']} kWh)` },
    { label: 'Ti·ªÅn n∆∞·ªõc', value: roomData['N∆Ø·ªöC'], detail: '-' },
    { label: 'Ph√≠ d·ªãch v·ª•', value: roomData['DV'], detail: '-' },
  ];

  const handleCopy = () => {
    const textToCopy = getPlainTextInvoice(roomData, paymentInfo);
    navigator.clipboard.writeText(textToCopy);
    alert('ƒê√£ sao ch√©p n·ªôi dung h√≥a ƒë∆°n!');
  };

  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 print:hidden">
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div className="flex justify-between items-center p-4 border-b dark:border-gray-700">
          <h3 className="text-xl font-semibold text-gray-900 dark:text-white">
            H√≥a ƒë∆°n Ph√≤ng {roomData['T√äN PH√íNG']}
          </h3>
          <button onClick={onClose} className="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
          </button>
        </div>
        <div className="p-6 overflow-y-auto">
          <div id="invoice-printable-area" className="bg-white p-8 sm:p-10 print:bg-white">
            <div className="flex justify-between items-start mb-10">
              <div>
                <h1 className="text-2xl font-bold text-gray-900 dark:text-white print:text-black">H√ìA ƒê∆†N TI·ªÄN NH√Ä</h1>
                <p className="text-gray-500 dark:text-gray-400 print:text-black">Th√°ng {currentMonth}/{currentYear}</p>
              </div>
              <div className="text-right">
                <h2 className="text-lg font-semibold text-gray-900 dark:text-white print:text-black">Ph√≤ng {roomData['T√äN PH√íNG']}</h2>
                <p className="text-sm text-gray-500 dark:text-gray-400 print:text-black">Ng√†y xu·∫•t: {currentDate}</p>
              </div>
            </div>
            <div className="mb-8 grid grid-cols-2 gap-x-4">
              <div>
                <p className="text-sm text-gray-500 dark:text-gray-400 print:text-black">G·ª≠i ƒë·∫øn:</p>
                <p className="font-medium text-gray-900 dark:text-white print:text-black">{roomData['T√äN']}</p>
              </div>
              {roomData['S·ªê NG∆Ø·ªúI'] && (
                <div className="text-right">
                    <p className="text-sm text-gray-500 dark:text-gray-400 print:text-black">S·ªë ng∆∞·ªùi:</p>
                    <p className="font-medium text-gray-900 dark:text-white print:text-black">{roomData['S·ªê NG∆Ø·ªúI']}</p>
                </div>
              )}
            </div>
            <div className="flow-root">
              <table className="min-w-full text-left">
                <thead className="text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-600">
                  <tr>
                    <th scope="col" className="py-3 pr-3 font-semibold print:text-black">M·ª•c</th>
                    <th scope="col" className="hidden py-3 px-3 text-right font-semibold sm:table-cell print:text-black">Chi ti·∫øt</th>
                    <th scope="col" className="py-3 pl-3 text-right font-semibold print:text-black">Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody>
                  {invoiceItems.map((item, index) => (
                    <tr key={index} className="border-b border-gray-200 dark:border-gray-700">
                      <td className="py-4 pr-3 text-gray-700 dark:text-gray-300 print:text-black">{item.label}</td>
                      <td className="hidden py-4 px-3 text-right text-sm text-gray-500 dark:text-gray-400 sm:table-cell print:text-black">{item.detail}</td>
                      <td className="py-4 pl-3 text-right font-medium text-gray-800 dark:text-gray-200 print:text-black">{item.value || '-'}</td>
                    </tr>
  
                  ))}
                </tbody>
                <tfoot>
                  <tr>
                    <th scope="row" colSpan={2} className="hidden pt-6 pr-3 text-right font-semibold text-gray-900 dark:text-white sm:table-cell print:text-black">T·ªîNG C·ªòNG</th>
                    <th scope="row" className="pt-6 pl-3 text-left font-semibold text-gray-900 dark:text-white sm:hidden print:text-black">T·ªîNG C·ªòNG</th>
                    <td className="pt-6 pl-3 text-right font-semibold text-lg text-blue-600 dark:text-blue-400 print:text-black">{roomData['T·ªîNG TI·ªÄN PH·∫¢I THANH TO√ÅN']}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div className="mt-10 pt-6 border-t border-gray-200 dark:border-gray-600">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white print:text-black">Th√¥ng tin thanh to√°n</h3>
              <dl className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div className="col-span-1"><dt className="text-gray-500 dark:text-gray-400 print:text-black">Ng√¢n h√†ng:</dt><dd className="font-medium text-gray-900 dark:text-gray-100 print:text-black">{paymentInfo.bankName}</dd></div>
                <div className="col-span-1"><dt className="text-gray-500 dark:text-gray-400 print:text-black">Ch·ªß t√†i kho·∫£n:</dt><dd className="font-medium text-gray-900 dark:text-gray-100 print:text-black">{paymentInfo.accountName}</dd></div>
                <div className="col-span-1"><dt className="text-gray-500 dark:text-gray-400 print:text-black">S·ªë t√†i kho·∫£n:</dt><dd className="font-medium text-gray-900 dark:text-gray-100 print:text-black">{paymentInfo.accountNumber}</dd></div>
                <div className="col-span-1"><dt className="text-gray-500 dark:text-gray-400 print:text-black">N·ªôi dung:</dt><dd className="font-medium text-gray-900 dark:text-gray-100 print:text-black">"{paymentNote}"</dd></div>
              </dl>
              <p className="mt-6 text-sm text-gray-500 dark:text-gray-400 print:text-black">C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n ƒë√∫ng h·∫°n!</p>
            </div>
          </div>
        </div>
        <div className="flex items-center justify-end p-4 border-t dark:border-gray-700 space-x-2">
            <button
              onClick={handlePrint}
              className="flex items-center justify-center text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clipRule="evenodd" />
              </svg>
              In PDF
            </button>
            <button
              onClick={handleCopy}
              className="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800"
            >
              Sao ch√©p
            </button>
            <button 
              onClick={onClose}
              className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600"
            >
              ƒê√≥ng
            </button>
        </div>
      </div>
    </div>
  );
}


// === From components/DataTable.tsx ===
function DataTable({ data, onGenerateInvoice }: { data: RoomData[]; onGenerateInvoice: (roomData: RoomData) => void; }): React.ReactNode {
  const DISPLAY_HEADERS = ['', ...REQUIRED_HEADERS];

  return (
    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden">
      <div className="overflow-x-auto">
        <table className="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead className="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              {DISPLAY_HEADERS.map((header, index) => (
                <th key={index} scope="col" className="px-6 py-3 whitespace-nowrap">
                  {String(header)}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.map((row, index) => (
              <tr key={index} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <td className="px-6 py-4 whitespace-nowrap">
                  <button
                    onClick={() => onGenerateInvoice(row)}
                    className="font-medium text-blue-600 dark:text-blue-500 hover:underline"
                  >
                    T·∫°o H√≥a ƒê∆°n
                  </button>
                </td>
                {REQUIRED_HEADERS.map((header, headerIndex) => (
                  <td key={`${index}-${headerIndex}`} className="px-6 py-4 whitespace-nowrap">
                    {row[header as keyof RoomData]}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}


// === From components/DataInputForm.tsx ===
function DataInputForm({ onSubmit, isLoading }: { onSubmit: (sheetUrl: string, range: string, paymentInfo: PaymentInfo) => void; isLoading: boolean; }): React.ReactNode {
  const InputField = ({ id, label, placeholder, value, onChange, type = 'text' }: { id: string, label: string, placeholder: string, value: string, onChange: (e: React.ChangeEvent<HTMLInputElement>) => void, type?: string }) => (
    <div>
      <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{label}</label>
      <input
        type={type}
        id={id}
        value={value}
        onChange={onChange}
        className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
        placeholder={placeholder}
        required
      />
    </div>
  );

  const SETTINGS_KEY = 'invoiceGeneratorSettings';

  const getInitialState = () => {
    try {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) return JSON.parse(saved);
    } catch (e) {
        console.error("Could not parse settings from localStorage", e);
    }
    return {};
  };

  const initialState = getInitialState();

  const [sheetUrl, setSheetUrl] = useState<string>(initialState.sheetUrl || '');
  const [range, setRange] = useState<string>(initialState.range || 'A1:K29');
  const [bankName, setBankName] = useState<string>(initialState.bankName || 'MB Bank');
  const [accountNumber, setAccountNumber] = useState<string>(initialState.accountNumber || '0123456789');
  const [accountName, setAccountName] = useState<string>(initialState.accountName || 'NGUYEN VAN A');
  const [paymentNote, setPaymentNote] = useState<string>(initialState.paymentNote || 'CK tien nha thang {thang}');

  useEffect(() => {
      const settings = { sheetUrl, range, bankName, accountNumber, accountName, paymentNote };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }, [sheetUrl, range, bankName, accountNumber, accountName, paymentNote]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const paymentInfo: PaymentInfo = { bankName, accountNumber, accountName, paymentNote };
    onSubmit(sheetUrl, range, paymentInfo);
  };

  return (
    <div className="p-6 bg-white border border-gray-200 rounded-2xl shadow-md dark:bg-gray-800 dark:border-gray-700">
      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <InputField id="sheetUrl" label="Link Google Sheet" placeholder="https://docs.google.com/spreadsheets/d/..." value={sheetUrl} onChange={(e) => setSheetUrl(e.target.value)} />
            <p className="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
              M·∫πo: ƒê·ªÉ ch·ªçn m·ªôt trang t√≠nh c·ª• th·ªÉ, h√£y nh·∫•n v√†o tab c·ªßa n√≥ trong Google Sheet v√† sao ch√©p URL ƒë·∫ßy ƒë·ªß t·ª´ thanh ƒë·ªãa ch·ªâ.
            </p>
          </div>
          <InputField id="range" label="V√πng d·ªØ li·ªáu (vd: A1:K29)" placeholder="A1:K29" value={range} onChange={(e) => setRange(e.target.value)} />
        </div>
        
        <div className="pt-4 border-t border-gray-200 dark:border-gray-600">
            <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Th√¥ng tin thanh to√°n</h3>
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <InputField id="bankName" label="T√™n ng√¢n h√†ng" placeholder="Vietcombank" value={bankName} onChange={(e) => setBankName(e.target.value)} />
                <InputField id="accountNumber" label="S·ªë t√†i kho·∫£n" placeholder="0123456789" value={accountNumber} onChange={(e) => setAccountNumber(e.target.value)} />
                <InputField id="accountName" label="Ch·ªß t√†i kho·∫£n" placeholder="NGUYEN VAN A" value={accountName} onChange={(e) => setAccountName(e.target.value)} />
            </div>
        </div>

        <div>
           <InputField id="paymentNote" label="N·ªôi dung chuy·ªÉn kho·∫£n" placeholder="CK tien nha thang {thang}" value={paymentNote} onChange={(e) => setPaymentNote(e.target.value)} />
            <p className="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Ghi ch√∫: B·∫°n c√≥ th·ªÉ d√πng <code className="font-mono bg-gray-200 dark:bg-gray-600 rounded px-1 py-0.5 text-gray-800 dark:text-gray-200">{'{thang}'}</code> ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√°ng hi·ªán t·∫°i.
            </p>
        </div>

        <div className="flex justify-end">
          <button
            type="submit"
            disabled={isLoading}
            className="flex items-center justify-center text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            {isLoading ? <><Spinner className="h-5 w-5 -ml-1 mr-2" /> <span >ƒêang t·∫£i...</span></> : 'L·∫•y D·ªØ Li·ªáu'}
          </button>
        </div>
      </form>
    </div>
  );
}


// === From App.tsx ===
function App(): React.ReactNode {
  const [isLoadingData, setIsLoadingData] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const [tableData, setTableData] = useState<RoomData[] | null>(null);
  const [paymentInfo, setPaymentInfo] = useState<PaymentInfo | null>(null);
  const [selectedRoom, setSelectedRoom] = useState<RoomData | null>(null);
  const [isModalOpen, setIsModalOpen] = useState<boolean>(false);

  const handleFormSubmit = useCallback(async (sheetUrl: string, rangeStr: string, pInfo: PaymentInfo) => {
    setIsLoadingData(true);
    setError(null);
    setTableData(null);

    const gid = parseGidFromUrl(sheetUrl);

    const range = parseA1Notation(rangeStr);
    if (!range) {
        setError(`ƒê·ªãnh d·∫°ng v√πng d·ªØ li·ªáu '${rangeStr}' kh√¥ng h·ª£p l·ªá. Vui l√≤ng d√πng ƒë·ªãnh d·∫°ng nh∆∞ 'A1:K29'.`);
        setIsLoadingData(false);
        return;
    }

    const dataUrl = getGoogleSheetDataUrl(sheetUrl, range, gid);
    if (!dataUrl) {
      setError('Link Google Sheet kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.');
      setIsLoadingData(false);
      return;
    }
    
    setPaymentInfo(pInfo);

    try {
      const response = await fetch(dataUrl);
      if (!response.ok) {
        if (response.status === 404 || response.status === 400) {
             throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (l·ªói ${response.status}). Vui l√≤ng ki·ªÉm tra l·∫°i:\n1. Link Google Sheet c√≥ ch√≠nh x√°c kh√¥ng.\n2. V√πng d·ªØ li·ªáu (vd: A1:K29) c√≥ h·ª£p l·ªá kh√¥ng.\n3. Quy·ªÅn truy c·∫≠p c·ªßa Sheet ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l√† 'B·∫•t k·ª≥ ai c√≥ ƒë∆∞·ªùng li√™n k·∫øt'.\n\nüí° M·∫πo: ƒê·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông, h√£y th·ª≠ 'T·ªáp' > 'Chia s·∫ª' > 'Xu·∫•t b·∫£n l√™n web'.`);
        }
        throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. M√£ l·ªói: ${response.status}`);
      }
      
      const responseText = await response.text();
      
      const jsonpRegex = /google\.visualization\.Query\.setResponse\(([\s\S]*)\)/;
      const match = responseText.match(jsonpRegex);

      if (!match || !match[1]) {
        throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ Google. Vui l√≤ng ki·ªÉm tra l·∫°i Link v√† quy·ªÅn truy c·∫≠p c·ªßa Sheet.");
      }

      const jsonString = match[1];
      const jsonData = JSON.parse(jsonString);

      if (jsonData.status === 'error') {
        const errorMessage = jsonData.errors?.map((e: any) => e.detailed_message || e.message).join('\n') || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Google API.';
        throw new Error(`L·ªói t·ª´ Google Sheets:\n${errorMessage}`);
      }
      
      const parsedData = parseGvizJson(jsonData);

      if (parsedData.length === 0) {
        setError("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√≥ th·ªÉ x·ª≠ l√Ω trong v√πng b·∫°n ch·ªçn. H√£y ƒë·∫£m b·∫£o v√πng d·ªØ li·ªáu kh√¥ng b·ªã tr·ªëng v√† c√≥ c√°c c·ªôt c·∫ßn thi·∫øt.");
      } else {
        setTableData(parsedData);
      }

    } catch (e) {
      const errorMessage = e instanceof Error ? e.message : 'ƒê√£ c√≥ l·ªói kh√¥ng x√°c ƒë·ªãnh x·∫£y ra.';
      if (e instanceof SyntaxError) {
        setError("L·ªói ph√¢n t√≠ch d·ªØ li·ªáu: Ph·∫£n h·ªìi t·ª´ Google kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i link, v√πng d·ªØ li·ªáu v√† quy·ªÅn truy c·∫≠p c·ªßa Sheet.");
      } else {
        setError(errorMessage);
      }
      console.error(e);
    } finally {
      setIsLoadingData(false);
    }
  }, []);

  const handleGenerateInvoice = useCallback((roomData: RoomData) => {
    if (!paymentInfo) {
      setError('Vui l√≤ng nh·∫≠p th√¥ng tin thanh to√°n tr∆∞·ªõc.');
      return;
    }
    
    setSelectedRoom(roomData);
    setIsModalOpen(true);
    setError(null);

  }, [paymentInfo]);

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setSelectedRoom(null);
  };

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans p-4 sm:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto">
        <header className="text-center mb-10 print:hidden">
          <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400">
            Tr√¨nh T·∫°o H√≥a ƒê∆°n Ti·ªÅn Tr·ªç
          </h1>
          <p className="mt-2 text-lg text-gray-600 dark:text-gray-400">
            T·ª± ƒë·ªông t·∫°o h√≥a ƒë∆°n t·ª´ Google Sheet m·ªôt c√°ch nhanh ch√≥ng v√† ch√≠nh x√°c.
          </p>
        </header>
        
        <main className="print:hidden">
          <DataInputForm onSubmit={handleFormSubmit} isLoading={isLoadingData} />

          {isLoadingData && (
            <div className="mt-8 flex justify-center">
              <Spinner className="h-8 w-8 text-blue-500" />
            </div>
          )}
          
          {error && (
            <div className="mt-8 text-center p-4 bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 rounded-lg whitespace-pre-line">
              {error}
            </div>
          )}

          {tableData && (
            <div className="mt-12">
              <DataTable data={tableData} onGenerateInvoice={handleGenerateInvoice} />
            </div>
          )}
        </main>
      </div>
      
      <InvoiceModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        roomData={selectedRoom}
        paymentInfo={paymentInfo}
      />
    </div>
  );
}


// === Original index.tsx entry point ===
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
